<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff"/>
  <title>GameVault - Agregador de Bibliotecas</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
    .game-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .game-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    .sidebar-link.active { background-color: #e9eef6; color: #1a73e8; font-weight: 600; }
    .favorite-btn.favorited svg { fill: #f44336; stroke: #f44336; }
    .toast { transition: opacity 0.3s, transform 0.3s; }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
  </style>
</head>
<body class="text-gray-800">

<div class="flex h-screen overflow-hidden">
  <!-- Sidebar -->
  <aside class="w-64 bg-white border-r border-gray-200 flex-shrink-0 hidden md:block">
    <div class="p-6">
      <h1 class="text-2xl font-bold text-gray-900 flex items-center">GameVault</h1>
    </div>
    <nav class="mt-6 px-4" id="sidebar-nav">
      <a href="#" data-filter="all" class="sidebar-link active flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-100">Todos os Jogos</a>
      <a href="#" data-filter="favorites" class="sidebar-link flex items-center px-4 py-2 mt-2 text-gray-700 rounded-lg hover:bg-gray-100">Favoritos</a>
      <div id="categories-container" class="mt-4 pt-4 border-t border-gray-200"></div>
      <div class="mt-6 pt-6 border-t border-gray-200">
        <h3 class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Configurações</h3>
        <div class="px-4 py-2 flex items-center justify-between">
          <span class="text-sm text-gray-700">Sincronização Automática</span>
          <label class="switch">
            <input type="checkbox" id="periodic-sync-toggle">
            <span class="slider"></span>
          </label>
        </div>
        <div id="sync-status" class="px-4 py-1 text-xs text-gray-500">Desativada</div>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto">
    <header class="sticky top-0 bg-white/80 backdrop-blur-sm border-b border-gray-200 p-4 z-20 flex justify-between">
      <input type="text" id="search-bar" placeholder="Buscar na biblioteca..." class="w-full max-w-md px-4 py-2 border border-gray-300 rounded-full">
      <div class="relative ml-2" id="add-library-dropdown-container">
        <button id="add-library-btn" class="bg-blue-600 text-white px-4 py-2 rounded-full hover:bg-blue-700">Adicionar Biblioteca</button>
        <div id="add-library-dropdown" class="origin-top-right absolute right-0 mt-2 w-60 rounded-md shadow-lg bg-white hidden z-30">
          <div class="py-1">
            <a href="#" id="manage-local-sources-btn" class="block px-4 py-2 text-sm hover:bg-gray-100">Gerenciar Fontes Locais</a>
            <a href="#" id="manage-online-sources-btn" class="block px-4 py-2 text-sm hover:bg-gray-100">Gerenciar Fontes Online</a>
          </div>
        </div>
      </div>
    </header>

    <div class="p-4 md:p-8">
      <h2 id="library-title" class="text-3xl font-bold text-gray-900 mb-6">Sua Biblioteca</h2>
      <div id="game-library" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
      <div id="message-center" class="text-center py-16"></div>
    </div>
  </main>
</div>

<!-- Modais -->
<div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

<div id="online-sources-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
    <h3 class="text-xl font-semibold mb-4">Gerenciar Fontes Online</h3>
    <div id="online-sources-list" class="mb-4 max-h-60 overflow-y-auto"></div>
    <form id="add-online-source-form" class="flex items-center gap-2">
      <input type="url" id="source-url-input" placeholder="https://exemplo.com/biblioteca.json" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Adicionar</button>
    </form>
    <div class="flex justify-end mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Fechar</button></div>
  </div>
</div>

<div id="local-sources-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
    <h3 class="text-xl font-semibold mb-4">Gerenciar Fontes Locais</h3>
    <p class="text-sm text-gray-600 mb-4">Adicione arquivos .json do seu computador. Eles serão salvos no cache da aplicação.</p>
    <div id="local-sources-list" class="mb-4 max-h-60 overflow-y-auto"></div>
    <button id="add-local-source-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Adicionar Arquivo</button>
    <div class="flex justify-end mt-6"><button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md">Fechar</button></div>
  </div>
</div>

<div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transform translate-y-2 toast"></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE ---
let games = [];
let currentFilter = 'all';
let searchQuery = '';
const ONLINE_SOURCES_KEY = 'gameVaultOnlineSources';
const LOCAL_SOURCES_KEY = 'gameVaultLocalSources';
const PERIODIC_SYNC_KEY = 'gameVaultPeriodicSync';
const LAST_SYNC_KEY = 'gameVaultLastSync';

// --- DOM ---
const dom = {
  gameLibrary: document.getElementById('game-library'),
  searchBar: document.getElementById('search-bar'),
  sidebarNav: document.getElementById('sidebar-nav'),
  libraryTitle: document.getElementById('library-title'),
  messageCenter: document.getElementById('message-center'),
  categoriesContainer: document.getElementById('categories-container'),
  toast: document.getElementById('toast'),
  dropdown: {
    container: document.getElementById('add-library-dropdown-container'),
    button: document.getElementById('add-library-btn'),
    menu: document.getElementById('add-library-dropdown'),
  },
  modals: {
    backdrop: document.getElementById('modal-backdrop'),
    online: document.getElementById('online-sources-modal'),
    local: document.getElementById('local-sources-modal'),
    all: document.querySelectorAll('.modal'),
    closeButtons: document.querySelectorAll('.modal-close-btn'),
  },
  buttons: {
    manageOnline: document.getElementById('manage-online-sources-btn'),
    manageLocal: document.getElementById('manage-local-sources-btn'),
    addLocalSource: document.getElementById('add-local-source-btn'),
  },
  forms: {
    addOnlineSource: document.getElementById('add-online-source-form'),
  },
  lists: {
    onlineSources: document.getElementById('online-sources-list'),
    localSources: document.getElementById('local-sources-list'),
  },
  inputs: {
    sourceUrl: document.getElementById('source-url-input'),
  },
  sync: {
    toggle: document.getElementById('periodic-sync-toggle'),
    status: document.getElementById('sync-status')
  }
};

// --- STORAGE HELPERS ---
const getOnlineSources = () => JSON.parse(localStorage.getItem(ONLINE_SOURCES_KEY)) || [];
const saveOnlineSources = (sources) => localStorage.setItem(ONLINE_SOURCES_KEY, JSON.stringify(sources));
const getLocalSources = () => JSON.parse(localStorage.getItem(LOCAL_SOURCES_KEY)) || [];
const saveLocalSources = (sources) => localStorage.setItem(LOCAL_SOURCES_KEY, JSON.stringify(sources));
const getPeriodicSyncEnabled = () => localStorage.getItem(PERIODIC_SYNC_KEY) === 'true';
const setPeriodicSyncEnabled = (enabled) => localStorage.setItem(PERIODIC_SYNC_KEY, enabled.toString());
const getLastSyncTime = () => localStorage.getItem(LAST_SYNC_KEY) || 'Nunca';
const setLastSyncTime = () => localStorage.setItem(LAST_SYNC_KEY, new Date().toLocaleString('pt-BR'));

// --- UI HELPERS ---
const showMessage = (title, text) => {
  dom.messageCenter.innerHTML = `<h3 class="text-xl font-semibold text-gray-700">${title}</h3><p class="text-gray-500 mt-2">${text}</p>`;
  dom.gameLibrary.innerHTML = '';
};

const showToast = (message, isError = false) => {
  dom.toast.textContent = message;
  dom.toast.className = `fixed bottom-5 right-5 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transform translate-y-2 toast ${isError ? 'bg-red-600' : 'bg-gray-800'}`;
  dom.toast.classList.remove('opacity-0', 'translate-y-2');
  setTimeout(() => { dom.toast.classList.add('opacity-0', 'translate-y-2'); }, 3000);
};

// --- CACHE HELPERS ---
async function cacheFile(name, content) {
  const cache = await caches.open('gamevault-cache-v1');
  const response = new Response(content, { headers: { "Content-Type": "application/json" } });
  await cache.put(`/local/${name}`, response);
}

async function removeCachedFile(name) {
  const cache = await caches.open('gamevault-cache-v1');
  await cache.delete(`/local/${name}`);
}

// --- PERIODIC SYNC FUNCTIONS ---
const updateSyncStatus = () => {
  const isEnabled = getPeriodicSyncEnabled();
  dom.sync.toggle.checked = isEnabled;
  dom.sync.status.textContent = isEnabled ? 
    `Ativada (Última sincronização: ${getLastSyncTime()})` : 
    'Desativada';
};

const registerPeriodicSync = async () => {
  if (!('periodicSync' in window.registration)) {
    showToast('Sincronização periódica não suportada neste navegador', true);
    setPeriodicSyncEnabled(false);
    updateSyncStatus();
    return;
  }

  try {
    const status = await navigator.permissions.query({ name: 'periodic-background-sync' });
    if (status.state !== 'granted') {
      showToast('Permissão para sincronização periódica não concedida', true);
      setPeriodicSyncEnabled(false);
      updateSyncStatus();
      return;
    }

    await window.registration.periodicSync.register('gamevault-sync', {
      minInterval: 24 * 60 * 60 * 1000, // 1 dia
    });
    
    setPeriodicSyncEnabled(true);
    setLastSyncTime();
    showToast('Sincronização periódica ativada!');
    console.log('Periodic sync registered');
  } catch (error) {
    console.error('Periodic sync registration failed:', error);
    showToast('Falha ao ativar sincronização periódica', true);
    setPeriodicSyncEnabled(false);
  }
  updateSyncStatus();
};

const unregisterPeriodicSync = async () => {
  try {
    await window.registration.periodicSync.unregister('gamevault-sync');
    setPeriodicSyncEnabled(false);
    showToast('Sincronização periódica desativada');
    console.log('Periodic sync unregistered');
  } catch (error) {
    console.error('Periodic sync unregistration failed:', error);
  }
  updateSyncStatus();
};

const performBackgroundSync = async () => {
  console.log('Executando sincronização em background...');
  try {
    await loadAllSources();
    setLastSyncTime();
    updateSyncStatus();
    
    // Mostrar notificação se o app não estiver em primeiro plano
    if (!document.hasFocus() && 'Notification' in window && Notification.permission === 'granted') {
      new Notification('GameVault', {
        body: 'Biblioteca de jogos atualizada com sucesso!',
        icon: '/icon-192x192.png'
      });
    }
  } catch (error) {
    console.error('Erro na sincronização em background:', error);
  }
};

// --- ONLINE SOURCES LOGIC ---
const renderOnlineSourcesList = () => {
  const sources = getOnlineSources();
  dom.lists.onlineSources.innerHTML = sources.length === 0 
    ? `<p class="text-gray-500">Nenhuma fonte online adicionada.</p>`
    : sources.map(source => `
        <div class="flex items-center justify-between p-2 border-b">
          <span class="text-gray-700 truncate">${source}</span>
          <button class="remove-online-source-btn text-red-500 hover:text-red-700 font-bold text-xl" data-url="${source}">&times;</button>
        </div>
      `).join('');
};

// adicionar nova fonte
dom.forms.addOnlineSource.addEventListener('submit', (e) => {
  e.preventDefault();
  const newUrl = dom.inputs.sourceUrl.value.trim();
  if (newUrl) {
    const sources = getOnlineSources();
    if (!sources.includes(newUrl)) {
      saveOnlineSources([...sources, newUrl]);
      renderOnlineSourcesList();
      dom.inputs.sourceUrl.value = '';
      loadAllSources();
      
      // Se a sincronização periódica estiver ativa, sincronizar novamente
      if (getPeriodicSyncEnabled()) {
        performBackgroundSync();
      }
    } else {
      showToast('Essa fonte já foi adicionada.', true);
    }
  }
});

// remover fonte
dom.lists.onlineSources.addEventListener('click', (e) => {
  if (e.target.classList.contains('remove-online-source-btn')) {
    const urlToRemove = e.target.dataset.url;
    saveOnlineSources(getOnlineSources().filter(url => url !== urlToRemove));
    renderOnlineSourcesList();
    loadAllSources();
  }
});

// --- LOCAL SOURCES LOGIC ---
const renderLocalSourcesList = async () => {
  const sources = getLocalSources();
  dom.lists.localSources.innerHTML = sources.length === 0 
    ? `<p class="text-gray-500">Nenhum ficheiro local adicionado.</p>`
    : sources.map(name => `
        <div class="flex items-center justify-between p-2 border-b">
          <span class="text-gray-700 truncate">${name}</span>
          <button class="remove-local-source-btn text-red-500 hover:text-red-700 font-bold text-xl" data-name="${name}">&times;</button>
        </div>
      `).join('');
};

// Upload de novo arquivo
dom.buttons.addLocalSource.addEventListener('click', () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      await cacheFile(file.name, text);
      const sources = getLocalSources();
      if (!sources.includes(file.name)) {
        saveLocalSources([...sources, file.name]);
      }
      await renderLocalSourcesList();
      await loadAllSources();
      showToast(`Arquivo "${file.name}" adicionado!`);
    } catch (err) {
      console.error('Erro ao salvar arquivo no cache:', err);
      showToast('Não foi possível adicionar o ficheiro.', true);
    }
  };
  input.click();
});

// Remover arquivo
dom.lists.localSources.addEventListener('click', async (e) => {
  if (e.target.classList.contains('remove-local-source-btn')) {
    const name = e.target.dataset.name;
    await removeCachedFile(name);
    saveLocalSources(getLocalSources().filter(n => n !== name));
    await renderLocalSourcesList();
    await loadAllSources();
    showToast(`Arquivo "${name}" removido!`);
  }
});

// --- LOAD SOURCES ---
const loadAllSources = async () => {
  const onlineSources = getOnlineSources();
  const localSources = getLocalSources();

  if (onlineSources.length === 0 && localSources.length === 0) {
    showMessage('Bem-vindo ao GameVault!', 'Adicione uma fonte de jogos online ou local para começar.');
    return;
  }
  showMessage('A carregar jogos...', 'A procurar dados de todas as fontes.');

  // Online
  const onlinePromises = onlineSources.map(url =>
    fetch(url).then(res => res.ok ? res.json() : null).catch(() => null)
  );

  // Locais (via cache)
  const localPromises = localSources.map(async (name) => {
    try {
      const cache = await caches.open('gamevault-cache-v1');
      const res = await cache.match(`/local/${name}`);
      if (res) return res.json();
    } catch (err) {
      console.error("Erro lendo cache:", err);
    }
    return null;
  });

  const results = await Promise.all([...onlinePromises, ...localPromises]);
  const allGamesRaw = results.flat().filter(Boolean);

  // Remover duplicados
  const uniqueGames = new Map();
  allGamesRaw.forEach(game => { if (game && game.id) uniqueGames.set(game.id, game); });
  games = Array.from(uniqueGames.values());

  if (games.length === 0) {
    showMessage('Nenhum jogo encontrado', 'Não foi possível carregar jogos.');
  } else {
    dom.messageCenter.innerHTML = '';
    populateCategories();
    renderGames();
  }
};

// --- RENDERIZAÇÃO ---
const renderGames = () => {
  dom.gameLibrary.innerHTML = '';
  const filteredGames = games.filter(game => {
    const name = game['nome do jogo'] || '';
    const category = game.categoria || '';
    const matchesSearch = name.toLowerCase().includes(searchQuery.toLowerCase());
    let matchesFilter = false;
    if (currentFilter === 'all') matchesFilter = true;
    else if (currentFilter === 'favorites') matchesFilter = game.favorito;
    else if (currentFilter.startsWith('category:')) {
      matchesFilter = category === currentFilter.split(':')[1];
    }
    return matchesSearch && matchesFilter;
  });

  if (games.length > 0 && filteredGames.length === 0) {
    showMessage('Nenhum jogo encontrado', 'Tente ajustar a sua pesquisa ou filtro.');
    return;
  }

  filteredGames.forEach(game => {
    const card = document.createElement('div');
    card.className = "game-card bg-white rounded-lg overflow-hidden shadow-md border flex flex-col";
    card.title = game.descrição || '';
    card.innerHTML = `
      <div class="relative">
        <img src="${game.capa}" class="w-full h-64 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x400/ccc/fff?text=Capa'">
        <button class="favorite-btn absolute top-2 right-2 p-2 bg-white/70 rounded-full ${game.favorito ? 'favorited' : ''}" data-id="${game.id}">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 
            19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        </button>
      </div>
      <div class="p-4 flex-grow flex flex-col">
        <h3 class="text-lg font-semibold truncate flex-grow">${game['nome do jogo']}</h3>
        <p class="text-sm text-gray-500">${game.categoria || 'Sem categoria'}</p>
        <div class="mt-4">
          <button class="play-btn bg-blue-600 text-white px-4 py-2 rounded-md text-sm w-full hover:bg-blue-700" data-link="${game['link do jogo local'] || ''}">Jogar</button>
        </div>
      </div>`;
    dom.gameLibrary.appendChild(card);
  });
};

// --- CATEGORIAS ---
const populateCategories = () => {
  dom.categoriesContainer.innerHTML = '';
  if (games.length === 0) return;
  const categories = [...new Set(games.map(game => game.categoria).filter(Boolean))].sort();
  if (categories.length > 0) {
    const list = categories.map(cat => `
      <a href="#" data-filter="category" data-category="${cat}" class="sidebar-link flex items-center px-4 py-2 mt-2 text-gray-700 rounded-lg hover:bg-gray-100">${cat}</a>
    `).join('');
    dom.categoriesContainer.innerHTML = `<h3 class="px-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Categorias</h3>${list}`;
  }
};

// --- UI & MODAL LOGIC ---
const openModal = (modal) => { 
  dom.modals.backdrop.classList.remove('hidden'); 
  modal.classList.remove('hidden'); 
};
const closeModal = () => { 
  dom.modals.all.forEach(m => m.classList.add('hidden')); 
  dom.modals.backdrop.classList.add('hidden'); 
};

dom.modals.closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
dom.modals.backdrop.addEventListener('click', closeModal);

dom.buttons.manageOnline.addEventListener('click', (e) => { 
  e.preventDefault(); 
  renderOnlineSourcesList(); 
  openModal(dom.modals.online); 
  dom.dropdown.menu.classList.add('hidden'); 
});
dom.buttons.manageLocal.addEventListener('click', (e) => { 
  e.preventDefault(); 
  renderLocalSourcesList(); 
  openModal(dom.modals.local); 
  dom.dropdown.menu.classList.add('hidden'); 
});

// --- GERAL ---
dom.dropdown.button.addEventListener('click', () => dom.dropdown.menu.classList.toggle('hidden'));
window.addEventListener('click', (e) => { if (!dom.dropdown.container.contains(e.target)) dom.dropdown.menu.classList.add('hidden'); });
dom.searchBar.addEventListener('input', (e) => { searchQuery = e.target.value; renderGames(); });

// Favoritar e Jogar
dom.gameLibrary.addEventListener('click', async (e) => {
  const favoriteBtn = e.target.closest('.favorite-btn');
  if (favoriteBtn) {
    const gameId = parseInt(favoriteBtn.dataset.id);
    const game = games.find(g => g.id === gameId);
    if (game) { 
      game.favorito = !game.favorito; 
      renderGames(); 
    }
    return;
  }
  const playBtn = e.target.closest('.play-btn');
  if (playBtn) {
    const link = playBtn.dataset.link;
    if (!link) { showToast("Este jogo não possui um link local.", true); return; }
    try {
      await navigator.clipboard.writeText(link);
      playBtn.textContent = 'Copiado!';
      setTimeout(() => { playBtn.textContent = 'Jogar'; }, 2000);
    } catch (err) { 
      showToast('Não foi possível copiar o link.', true); 
    }
  }
});

// Sidebar filtros
dom.sidebarNav.addEventListener('click', (e) => {
  e.preventDefault();
  const link = e.target.closest('.sidebar-link');
  if (!link) return;
  dom.sidebarNav.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
  link.classList.add('active');
  const filterType = link.dataset.filter;
  if (filterType === 'category') {
    currentFilter = `category:${link.dataset.category}`;
    dom.libraryTitle.textContent = link.dataset.category;
  } else {
    currentFilter = filterType;
    dom.libraryTitle.textContent = link.textContent.trim();
  }
  renderGames();
});

// Periodic Sync Toggle
dom.sync.toggle.addEventListener('change', async (e) => {
  if (e.target.checked) {
    await registerPeriodicSync();
  } else {
    await unregisterPeriodicSync();
  }
});

// --- PWA Service Worker ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { 
    navigator.serviceWorker.register('./sw.js').then(registration => {
      console.log('Service Worker registrado com sucesso:', registration);
      
      // Verificar se a sincronização periódica está disponível
      if ('periodicSync' in registration) {
        console.log('Periodic Sync está disponível');
        
        // Verificar se já temos uma sincronização registrada
        registration.periodicSync.getTags().then(tags => {
          if (tags.includes('gamevault-sync')) {
            setPeriodicSyncEnabled(true);
            updateSyncStatus();
          }
        });
      } else {
        console.log('Periodic Sync não está disponível');
        dom.sync.toggle.disabled = true;
        dom.sync.status.textContent = 'Não suportado neste navegador';
      }
    }).catch(error => {
      console.log('Falha no registro do Service Worker:', error);
    });
  });
}

// --- INICIALIZAÇÃO ---
loadAllSources();
updateSyncStatus();
});
</script>
</body>
</html>
